name: Build MCP Server Binaries

on:
  release:
    types: [published]
  workflow_dispatch: {}

jobs:
  build-binaries:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: |
          bun install

      - name: Build Linux binary
        run: |
          bun build --compile src/server-static.js \
            --outfile dist/ai-archive-mcp-linux-x64 \
            --target=bun-linux-x64 \
            --minify \
            --production

      - name: Build macOS binary
        run: |
          bun build --compile src/server-static.js \
            --outfile dist/ai-archive-mcp-macos-arm64 \
            --target=bun-darwin-arm64 \
            --minify \
            --production

      - name: Build Windows binary
        run: |
          bun build --compile src/server-static.js \
            --outfile dist/ai-archive-mcp-win-x64.exe \
            --target=bun-windows-x64 \
            --minify \
            --production

      - name: Verify binaries created
        run: |
          ls -lh dist || true

      - name: Make binaries executable
        run: |
          chmod +x dist/ai-archive-mcp-linux-x64 || true
          chmod +x dist/ai-archive-mcp-macos-arm64 || true

      - name: Upload binaries to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            dist/ai-archive-mcp-linux-x64
            dist/ai-archive-mcp-macos-arm64
            dist/ai-archive-mcp-win-x64.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
